function exportSymptoms(){exportData(symptomsDimension.top(1/0),"symptoms")}function exportSyndromes(){exportData(syndromesDimension.top(1/0),"syndromes")}function exportData(a,b){if(a.length>0){var c=new Array,d=[];for(var e in a[0])d.push('"'+e+'"');c.push(d.join(",")),a.forEach(function(a){var b=[];for(var d in a)b.push('"'+a[d]+'"');c.push(b.join(","))});var f="data-"+b+".csv",g=c.join("\n"),h=new Blob([g],{type:"text/csv;charset=utf8;"}),i=document.createElement("a");void 0!==i.download&&(i.setAttribute("href",window.URL.createObjectURL(h)),i.setAttribute("download",f),i.click())}}function changeDate(a,b){switch(a){case"thisweek":var c=[new Date(maxDate-6048e5),maxDate];b.focus(c);break;case"last24":var c=[new Date(maxDate-864e5),maxDate];b.focus(c);break;case"reset":b.focus(null),dc.redrawAll()}}function activaTab(a){$('.nav-tabs a[href="#'+a+'"]').tab("show")}var minDate=new Date(2014,5,1),maxDate=new Date(2014,5,30),symptomsCases,syndromesCases;$.ajax("data/symptoms.json",{async:!1,ifModified:!0,dataType:"json"}).done(function(a){symptomsCases=a}),$.ajax("data/syndromes.json",{async:!1,ifModified:!0,dataType:"json"}).done(function(a){syndromesCases=a}),symptomsCases.forEach(function(a){a.ageGroup=10*Math.floor(a.age/10)}),syndromesCases.forEach(function(a){a.ageGroup=10*Math.floor(a.age/10)});var symptomsDataset=crossfilter(symptomsCases),allSymptoms=symptomsDataset.groupAll(),syndromesDataset=crossfilter(syndromesCases),allSyndromes=syndromesDataset.groupAll(),symptomsDimension=symptomsDataset.dimension(function(a){return a.symptom}),symptomsGroup=symptomsDimension.group(),symptomsDateDimension=symptomsDataset.dimension(function(a){return new Date(a.date_onset)}),syndromesDimension=syndromesDataset.dimension(function(a){return a.syndrome}),syndromesGroup=syndromesDimension.group(),syndromesDateDimension=syndromesDataset.dimension(function(a){return new Date(a.date_onset)}),setDefaultColors=function(a,b){var c=[0,b.top(1)[0].value];return a.colors(d3.scale.quantize().domain(c).range(["#E2F2FF","#C4E4FF","#9ED2FF","#81C5FF","#6BBAFF","#51AEFF","#36A2FF","#1E96FF","#0089FF","#0061B5"]))},classesColorScale=d3.scale.category10(),buildRowChart=function(a,b,c){var d=dc.rowChart(a).width(260).height(384).margins({top:40,left:10,right:10,bottom:20}).colors(classesColorScale).colorAccessor(function(a,b){return b}).group(c).dimension(b).label(function(a){return a.key}).title(function(a){return a.value}).elasticX(!0);return d},syndromesChart=buildRowChart("#syndromesChart",syndromesDimension,syndromesGroup),symptomsChart=buildRowChart("#symptomsChart",symptomsDimension,symptomsGroup),syndromesCountChart=dc.dataCount("#syndromesCount").dimension(syndromesDataset).group(allSyndromes),symptomsCountChart=dc.dataCount("#symptomsCount").dimension(symptomsDataset).group(allSymptoms),regions,regionsGroup;d3.json("data/rio_aps.geojson",function(a){var b=function(b,c){regions=c.dimension(function(a){return a.region}),regionsGroup=regions.group();var d=850,e=350,f=d3.geo.mercator().center([-43.3,-23]).scale(45e3),g=dc.geoChoroplethChart(b).width(d).height(e).dimension(regions).group(regionsGroup).colorAccessor(function(a){return a}).overlayGeoJson(a.features,"region",function(a){return a.properties.NOME}).projection(f).title(function(a){return"Region: "+a.key+"\nCount: "+(a.value||0)});return setDefaultColors(g,regionsGroup),g},c=b("#syndromesMap",syndromesDataset),d=b("#symptomsMap",symptomsDataset);c.render(),d.render()});var ageSteps=[5,10,15,20,25,30,40,50,60],buildAgeChart=function(a,b){var c=b.dimension(function(a){return a.ageGroup}),d=c.group(function(a){return 10*Math.floor(a/10)}),e=dc.rowChart(a).width(400).height(300).margins({top:25,right:40,bottom:30,left:40}).dimension(c).colorAccessor(function(a){return a.value}).group(d).label(function(a){return a.key+" - "+(a.key+9)});return setDefaultColors(e,d),e};buildAgeChart("#syndromesAgeChart",syndromesDataset),buildAgeChart("#symptomsAgeChart",symptomsDataset);var buildDemographicPieChart=function(a,b,c){var d=b.dimension(function(a){return a[c]}),e=d.group();return dc.pieChart(a).width(250).height(200).dimension(d).group(e)};buildDemographicPieChart("#syndromesGenderChart",syndromesDataset,"gender"),buildDemographicPieChart("#symptomsGenderChart",symptomsDataset,"gender");var syndromesRoleChart=buildDemographicPieChart("#syndromesRoleChart",syndromesDataset,"role"),symptomsRoleChart=buildDemographicPieChart("#symptomsRoleChart",symptomsDataset,"role"),buildBooleanPieChart=function(a,b,c,d,e){var f=b.dimension(function(a){return"1"==a[c]?d||"yes":e||"no"}),g=f.group();return dc.pieChart(a).width(250).height(200).dimension(f).group(g)};buildBooleanPieChart("#syndromesNeedsHelpChart",syndromesDataset,"needs_help"),buildBooleanPieChart("#symptomsNeedsHelpChart",symptomsDataset,"needs_help"),buildBooleanPieChart("#syndromesForeignerChart",syndromesDataset,"foreigner","foreigner","national"),buildBooleanPieChart("#symptomsForeignerChart",symptomsDataset,"foreigner","foreigner","national");var buildTimeChart=function(a,b,c,d,e,f){var g=(["days",d3.time.days],dc.compositeChart(d)),h=dc.barChart(e),i=f,j=i.group(function(a){return d3.time.day(a)}),k=i.group(function(a){return d3.time.day(a)}).reduce(function(a,b){return a[b[c]]=(a[b[c]]||0)+1,a},function(a,b){return--a[b[c]],a},function(){return{}}),l=b.all().map(function(a){return a.key});g.width(950).height(300).margins({top:10,right:120,bottom:20,left:40}).rangeChart(h).shareTitle(!1).transitionDuration(100).elasticY(!0).x(d3.time.scale()).xUnits(d3.time.days).yAxisLabel("no. cases").xAxis();var m=[];return l.forEach(function(a,b){m.push(dc.lineChart(g).dimension(i).colors(classesColorScale(b)).group(k,l[b],function(b){return b.value[a]||null}).defined(function(a){return!isNaN(a.y)}).interpolate("monotone"))}),g.compose(m).brushOn(!1),g.rangeChart(h).transitionDuration(100).x(d3.time.scale().domain([minDate,maxDate])).xUnits(d3.time.days).xAxis(),h.width(850).height(60).margins({top:10,right:20,bottom:20,left:50}).dimension(i).group(j).centerBar(!0).gap(1).x(d3.time.scale().domain([minDate,maxDate])).round(d3.time.days.round).alwaysUseRounding(!0).xUnits(d3.time.days).yAxis().ticks(0),g},syndromesNavTimeChart=buildTimeChart(syndromesDataset,syndromesGroup,"syndrome","#syndromesTimeSeries","#syndromesTimeNavigation",syndromesDateDimension),symptomsNavTimeChart=buildTimeChart(symptomsDataset,symptomsGroup,"symptom","#symptomsTimeSeries","#symptomsTimeNavigation",symptomsDateDimension),buildTable=function(a,b,c,d){return dc.dataTable(d).dimension(c).group(function(){return""}).size(20).columns([function(a){return a.user_id},function(a){return a.gender},function(a){return a.age},function(a){return a[b]},function(a){var b=new Date(a.date_onset),c=new Date(a.date_reported),d=Math.abs(c.getTime()-b.getTime()),e=Math.ceil(d/864e5);return e},function(a){return a.date_onset},function(a){return'<a href="http://maps.google.com/maps?z=10&t=m&q=loc:'+String(a.lat_reported)+"+"+String(a.lng_reported)+'" target="_blank">Map</a>'}])};buildTable(syndromesDataset,"syndrome",syndromesDateDimension,"#syndromesCaseList"),buildTable(symptomsDataset,"symptom",symptomsDateDimension,"#symptomsCaseList"),$("#datasetTabs a").click(function(a){a.preventDefault(),$(this).tab("show")}).first().tab("show");var setFilters=function(a){a.syndrome?(syndromesChart.filter(a.syndrome),dc.redrawAll(),$("#syndromesTab").tab("show")):a.symptom&&(symptomsChart.filter(a.symptom),dc.redrawAll(),$("#symptomsTab").tab("show"))},userAlerts=[{alert_date:"2015-06-07",alert_syndrome:"Diarreica",alert_region:"Brasilia"}],setFilters=function(a){syndromesChart.filter(a.syndrome),dc.redrawAll()};dc.renderAll(),window.setTimeout(function(){dc.redrawAll()},1e3);